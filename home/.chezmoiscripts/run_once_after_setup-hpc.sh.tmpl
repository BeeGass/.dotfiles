{{ if .isHpc -}}
#!/bin/bash
set -euo pipefail
source "$HOME/.dotfiles/scripts/lib-common.sh"

section "HPC cluster bootstrap"

LOCAL_BIN="$HOME/.local/bin"
PLUG_DIR="$HOME/.zsh/plugins"
mkdir -p "$LOCAL_BIN"
export PATH="$LOCAL_BIN:$PATH"

# Try to make zsh the login shell
if have zsh; then
    ok "zsh already available"
elif have module; then
    step "Trying 'module load zsh'"
    module load zsh 2>/dev/null || true
fi

# Rust toolchain (needed for cargo packages)
if ! have cargo; then
    step "Installing Rust via rustup"
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
    source "$HOME/.cargo/env" 2>/dev/null || true
fi

# Cargo packages
for pkg in bat fd-find ripgrep delta eza; do
    bin_name="$pkg"
    case "$pkg" in
        fd-find) bin_name="fd" ;;
        ripgrep) bin_name="rg" ;;
        delta) bin_name="delta" ;;
    esac
    if ! have "$bin_name"; then
        step "Installing $pkg via cargo"
        cargo install "$pkg" 2>/dev/null || warn "Failed to install $pkg"
    fi
done

# fzf
if ! have fzf; then
    step "Installing fzf"
    if [[ ! -d "$HOME/.fzf" ]]; then
        git clone --depth 1 https://github.com/junegunn/fzf.git "$HOME/.fzf"
    fi
    "$HOME/.fzf/install" --bin --no-update-rc --no-key-bindings --no-completion
    ln -sf "$HOME/.fzf/bin/fzf" "$LOCAL_BIN/fzf"
fi

# Zsh plugins
step "Installing zsh plugins"
mkdir -p "$PLUG_DIR"
if [[ ! -d "$PLUG_DIR/zsh-autosuggestions" ]]; then
    git clone --depth 1 https://github.com/zsh-users/zsh-autosuggestions "$PLUG_DIR/zsh-autosuggestions"
fi
if [[ ! -d "$PLUG_DIR/zsh-syntax-highlighting" ]]; then
    git clone --depth 1 https://github.com/zsh-users/zsh-syntax-highlighting "$PLUG_DIR/zsh-syntax-highlighting"
fi

ok "HPC bootstrap complete"
{{ end -}}
