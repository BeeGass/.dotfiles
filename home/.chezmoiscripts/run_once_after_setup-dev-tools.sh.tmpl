#!/bin/bash
set -euo pipefail
source "$HOME/.dotfiles/scripts/lib-common.sh"

section "Install developer tools"

# oh-my-posh
step "Installing oh-my-posh"
{{ if eq .chezmoi.os "darwin" -}}
brew install jandedobbeleer/oh-my-posh/oh-my-posh || true
{{ else -}}
curl -s https://ohmyposh.dev/install.sh | bash -s -- -d "$HOME/.local/bin"
{{ end }}

# prek (pre-commit replacement)
step "Installing prek"
{{ if ne .chezmoi.os "darwin" -}}
if ! command -v prek >/dev/null 2>&1; then
  curl -fsSL https://raw.githubusercontent.com/j178/prek/main/install.sh | bash || warn "prek install failed"
fi
{{ end -}}

# uv + Python
step "Installing uv and Python toolchains"
if ! command -v uv >/dev/null 2>&1; then
  curl -Ls https://astral.sh/uv/install.sh | sh
fi
export PATH="$HOME/.local/bin:$PATH"
uv self update || true
uv python install 3.11 3.12 3.13 3.14 || true
for tool in 'python-lsp-server[all]' ruff mypy pytest pre-commit; do
  uv tool install "$tool" 2>/dev/null || true
done
ok "Python tools installed"

# nvm + Node
step "Installing nvm and Node.js LTS"
export NVM_DIR="$HOME/.nvm"
if [ ! -s "$NVM_DIR/nvm.sh" ]; then
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
fi
. "$NVM_DIR/nvm.sh"
nvm install --lts
nvm alias default 'lts/*'
ok "Node.js installed"

# CLIs
step "Installing global CLI tools"
npm install -g @google/gemini-cli@latest @openai/codex@latest \
  typescript typescript-language-server 2>/dev/null || true
ok "CLI tools installed"

{{ if ne .chezmoi.os "darwin" -}}
# Claude Code CLI (macOS gets it via Homebrew cask)
step "Installing Claude Code CLI"
if ! command -v claude >/dev/null 2>&1; then
  curl -fsSL https://claude.ai/install.sh | bash || true
fi
{{ end -}}

# OpenCode CLI
step "Installing OpenCode CLI"
if ! command -v opencode >/dev/null 2>&1 && [ ! -d "$HOME/.opencode" ]; then
  curl -fsSL https://opencode.ai/install | bash || true
fi

# Tailscale
step "Installing Tailscale"
if ! command -v tailscale >/dev/null 2>&1; then
{{ if eq .chezmoi.os "darwin" -}}
  brew install tailscale || true
{{ else -}}
  curl -fsSL https://tailscale.com/install.sh | sh || true
{{ end -}}
fi

# SF Compute CLI
step "Installing SF Compute CLI"
if ! command -v sf >/dev/null 2>&1; then
  curl -fsSL https://sfcompute.com/cli/install | bash || warn "SF Compute CLI install failed"
fi

# Neofetch image assets
step "Downloading neofetch image assets"
NEOFETCH_IMG_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/neofetch/pics"
mkdir -p "$NEOFETCH_IMG_DIR"
if ! find "$NEOFETCH_IMG_DIR" -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.webp' \) 2>/dev/null | grep -q .; then
  if command -v uvx >/dev/null 2>&1; then
    uvx gdown 'https://drive.google.com/drive/folders/1vjMG9j9t9cay5baPQbYLngWRi-EQ2pyK?usp=sharing' \
      --folder --no-cookies --output "$NEOFETCH_IMG_DIR" \
      || warn "Neofetch asset download failed"
  else
    warn "uvx not found; skipping neofetch assets"
  fi
fi

# prek (pre-commit) hooks for dotfiles repo
step "Installing prek git hooks"
if [[ -d "$HOME/.dotfiles/.git" ]]; then
  if command -v prek >/dev/null 2>&1; then
    (cd "$HOME/.dotfiles" && prek install --install-hooks 2>/dev/null) || warn "prek hook install failed"
    ok "prek hooks installed"
  elif command -v pre-commit >/dev/null 2>&1; then
    (cd "$HOME/.dotfiles" && pre-commit install --install-hooks 2>/dev/null) || warn "pre-commit hook install failed"
    ok "pre-commit hooks installed (fallback)"
  else
    note "Neither prek nor pre-commit found; skipping hook install"
  fi
fi

ok "Developer tools setup complete"
